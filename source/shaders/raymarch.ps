struct ps_in
{
	float4		Position : SV_Position;
};

cbuffer RaymarchParams : register(b0)
{
	uint		ScreenWidth,
				ScreenHeight;
	float		MinVal,
				MaxVal;
};

static const uint MaxIterations = 32;

Texture3D<float>		Volume : register(t0);
Texture2D<float4>		BackPositions : register(t1);  // backface-culled, so frontface
Texture2D<float4>		FrontPositions : register(t2); // frontface-culled, so backface
SamplerState			LinearSampler : register(s0);

float4
main(ps_in Input) : SV_Target
{
	float2		Tex;
	float3		PosFront,
				PosBack,
				Dir,
				Pos;
	float		StepSize;


	Tex = Input.Position.xy / float2(ScreenWidth, ScreenHeight);

	PosBack = BackPositions.Sample(LinearSampler, Tex).xyz;
	PosFront = FrontPositions.Sample(LinearSampler, Tex).xyz;

	Dir = normalize(PosBack - PosFront);
	StepSize = length(PosFront - PosBack) / MaxIterations;

	Pos = PosFront;

	float MaxDensity = -1000000;

	for (uint I = 0; I < MaxIterations; I++)
	{
		float3 Pos = PosFront + I * StepSize * Dir;
		float Density = Volume.Sample(LinearSampler, Pos, int3(0, 0, 0));

		if (Density > MaxDensity)
		{
			MaxDensity = Density;
		}

		Pos += StepSize * Dir;
	}

	MaxDensity /= MaxVal;

	return float4(MaxDensity, MaxDensity, MaxDensity, 1);
}


